<!DOCTYPE html>
<html>
  <head>
    <title>Wake Word Ducking Example</title>
    <script src="https://unpkg.com/@picovoice/porcupine-web@latest/dist/iife/index.js"></script>
  </head>
  <body>
    <h1>ðŸŽ§ Wake Word Ducking with Porcupine</h1>
    <button id="start">Start</button>

    <script type="module">
      import { PorcupineWorker } from "https://unpkg.com/@picovoice/porcupine-web@latest/dist/esm/index.js";

      const startBtn = document.getElementById("start");

      startBtn.onclick = async () => {
        const accessKey =
          "Nr4WlA7OyL5Krr2BmJXz9wTMGhSjQug9a9xNecKo/myRhF74JcSCjg=="; // ðŸ”‘ Replace with your key

        // Updated syntax with proper configuration object
        const porcupineWorker = await PorcupineWorker.create(
          accessKey,
          [{ builtin: "Porcupine", sensitivity: 0.7 }],
          {
            publicPath:
              "https://unpkg.com/@picovoice/porcupine-web@latest/dist/",
            forceWrite: true,
          }
        );

        const audioCtx = new (window.AudioContext ||
          window.webkitAudioContext)();
        const musicGain = audioCtx.createGain();
        musicGain.gain.value = 1.0;

        // Load music and play it
        const response = await fetch(
          "https://cdn.jsdelivr.net/gh/mdn/webaudio-examples/voice-change-o-matic/audio/concert-crowd.ogg"
        );
        const buffer = await audioCtx.decodeAudioData(
          await response.arrayBuffer()
        );
        const musicSource = audioCtx.createBufferSource();
        musicSource.buffer = buffer;
        musicSource.loop = true;
        musicSource.connect(musicGain).connect(audioCtx.destination);
        musicSource.start();

        // Start mic stream
        const micStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        const micCtx = new AudioContext();
        const micSource = micCtx.createMediaStreamSource(micStream);
        const processor = micCtx.createScriptProcessor(512, 1, 1);

        micSource.connect(processor);
        processor.connect(micCtx.destination);

        processor.onaudioprocess = (event) => {
          const inputData = event.inputBuffer.getChannelData(0);
          const int16Array = new Int16Array(inputData.length);
          for (let i = 0; i < inputData.length; i++) {
            int16Array[i] = inputData[i] * 32767;
          }
          porcupineWorker.postMessage({
            command: "process",
            inputFrame: int16Array,
          });
        };

        // Handle detection
        porcupineWorker.onmessage = (msg) => {
          if (msg.data.command === "ppn-keyword") {
            console.log("Wake word detected!");
            musicGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            setTimeout(() => {
              musicGain.gain.setValueAtTime(1.0, audioCtx.currentTime);
            }, 3000); // Restore after 3s
          }
        };
      };
    </script>
  </body>
</html>
